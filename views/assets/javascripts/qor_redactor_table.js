"use strict";!function(r){r.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table","set-table-theme":"Set table theme","merge-cell":"Merge cell"}},modals:{setTableThemeModal:'<form action=""></form>'},onmodal:{setTableThemeModal:{open:function(t,e){if(!this.opts.setTableThemeModal&&void 0!==this.opts.tableClassNames){var a=this.opts.tableClassNames.split(";").reduce(function(t,e){var a=e.split(",");if(a&&2===a.length){var n=a[1];return t+'<option value="'+a[0]+'">'+n+"</option>"}},"");a='<option value="">No Theme</option>'+a,this.opts.setTableThemeModal='<div class="form-item"><label>Select Theme</label><select name="theme">'+a+"\n            </select></div>"}e.append(this.opts.setTableThemeModal)},save:function(t,e){var a=e.getData();a&&null!=a.theme&&this.app.api("plugin.table.setTableTheme",{classValue:a.theme})}}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.caret=t.caret,this.editor=t.editor,this.toolbar=t.toolbar,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.block=t.block},oncontextbar:function(t,e){var a=this.inspector.parse(t.target);if(a.isComponentType("table")){var n=a.getComponent(),o={};1<r.dom(n).find("[data-active]").length&&(o["merge-cell"]={title:this.lang.get("merge-cell"),api:"plugin.table.mergeCell",args:n}),Object.keys(o).length?e.set(t,n,o):e.close()}},ondropdown:{table:{observe:function(t){this._observeDropdown(t)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var t={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"}};void 0!==this.opts.tableClassNames&&(t["set-table-theme"]={title:this.lang.get("set-table-theme"),classname:"redactor-table-item-observable",api:"plugin.table.setTableThemeModal"});var e={title:this.lang.get("table")},a=this.toolbar.addButtonBefore("link","table",e);a.setIcon('<i class="re-icon-table"></i>'),a.setDropdown(t);this.minCellWidth=40;var n,o,b=!1,l=!1,r=$(this.app.editor.$editor.nodes[0]);r.on("focus","td,th",function(){r.find("td[data-active],th[data-active]").removeAttr("data-active"),$(this).attr("data-active",""),o=$(n=this).closest("thead,tbody")}),$("body").on("click",function(t){var e=0<$(t.target).closest("table").length,a=0<$(t.target).closest(".redactor-toolbar").length,n=0<$(t.target).closest(".redactor-dropdown").length;e||a||n||r.find("td[data-active],th[data-active]").removeAttr("data-active")}),r.on("mousedown","td, th",function(t){l="col-resize"==$(this).css("cursor");var e=$(this).closest("table"),a=$(this).closest(".redactor-component[data-redactor-type='table']");if(u.calcTableElementPosition(e),l){u.isColResize=!0,u.colResizeStartX=t.clientX,u.colResizeStartElement=t.target,u.colResizeStartPositionX=t.target.offsetLeft+t.offsetX,t.preventDefault();var n=$('<div class="redactor-component-table-line"></div>');n.css("left",u.colResizeStartPositionX),a.append(n)}else b=!!1}),$("body").on("mouseup",function(){$(".redactor-component-table-line").remove()}),r.on("mouseup",'.redactor-component[data-redactor-type="table"]',function(t){b=!!0;var e=$(this);if(u.isColResize){u.isColResize=!1;var a=u.colResizeStartElement.lastPoint.col;u.renderColGroup($(this).find("table"),a,u.changeColWidth),e.find(".redactor-component-table-line").remove()}}),r.on("mousemove","td, th",function(t){if(t.target.offsetWidth-t.offsetX<10&&!b?$(this).css("cursor","col-resize"):$(this).css("cursor",""),u.isColResize){for(var e,a=u.colResizeStartX-t.clientX,n=$(this).closest(".redactor-component[data-redactor-type='table']"),o=n.find("thead,tbody").outerWidth(),l=u.colResizeStartElement.lastPoint.col,r=null,i=null,s=0;s<u.tableHeadElements.length;s++){var d=u.tableHeadElements[s][l];(r=r||d).colSpan<d.colSpan&&(r=d);var c=u.tableHeadElements[s][l+1];(i=i||c).colSpan<c.colSpan&&(i=c)}for(s=0;s<u.tableBodyElements.length;s++){d=u.tableBodyElements[s][l];(r=r||d).colSpan>d.colSpan&&(r=d);c=u.tableBodyElements[s][l+1];(i=i||c).colSpan>c.colSpan&&(i=c)}var h,p=n.find("colgroup").find("col");if(0<a)e=(h=p.eq(l)).length?h.attr("width").split("%")[0]/100*o:t.target.offsetWidth/t.target.colSpan,1<r.colSpan&&(e=r.offsetWidth);else e=(h=p.eq(l+1)).length?h.attr("width").split("%")[0]/100*o:t.target.offsetWidth/t.target.colSpan,1<i.colSpan&&(e=i.offsetWidth);if(0<(e-u.minCellWidth>=Math.abs(a))){var m=t.clientX-u.colResizeStartX;n.find(".redactor-component-table-line").css("left",u.colResizeStartPositionX+m),u.changeColWidth=m}}}),r.on("mouseout","td, th",function(){});var u=this;r.on("mouseenter","td, th",function(){var t=$(this).closest("thead,tbody");b&&t[0]===o[0]&&(t.find("td[data-active],th[data-active]").removeAttr("data-active"),u.calcCellMergeRange(n,this),u.renderCellMergeRange(this.tagName,u.finalRange))})},renderColGroup:function(t,l,r){var e=this,a=t.find("colgroup"),i=t.find("thead,tbody").outerWidth(),n=(e.minCellWidth/i*100).toFixed(2),o=i*n/100;if(null!=l){for(var s=null,d=null,c=0;c<e.tableHeadElements.length;c++){var h=e.tableHeadElements[c][l];(s=s||h).colSpan<h.colSpan&&(s=h);var p=e.tableHeadElements[c][l+1];(d=d||p).colSpan<p.colSpan&&(d=p)}for(c=0;c<e.tableBodyElements.length;c++){h=e.tableBodyElements[c][l];(s=s||h).colSpan>h.colSpan&&(s=h);p=e.tableBodyElements[c][l+1];(d=d||p).colSpan>p.colSpan&&(d=p)}}if(null!=l&&null!=r&&a.length){var m=a.find("col"),b=a.find("col").eq(l),u=l+1,f=a.find("col").eq(u),v=b.attr("width").split("%")[0]/100*i,g=v*s.colSpan+r,w=f.attr("width").split("%")[0]/100*i,T=w*d.colSpan-r;g<o&&(r=(g=o)-v*s.colSpan),T<o&&(T=o,r=w*d.colSpan-o);for(var C=(v*s.colSpan+r)/i*100,E=(w*d.colSpan-r)/i*100,P=s.colSpan,S=d.colSpan;P--;){var R=l-P;m.eq(R).attr("width",(C/s.colSpan).toFixed(2)+"%")}for(;S--;){R=l+S+1;m.eq(R).attr("width",(E/d.colSpan).toFixed(2)+"%")}}else{a.remove();var H="<colgroup>"+e.tableBodyElements[0].reduce(function(t,e,a){var n=$(e).attr("colspan")||1,o=$(e).outerWidth();return o/=n,null!=l&&(l-s.colSpan+1<=a&&a<=l&&(o=(Number(o*s.colSpan)+Number(r))/s.colSpan),l+1<=a&&a<=l+1+-1+d.colSpan&&(o=(Number(o*d.colSpan)-Number(r))/d.colSpan)),t+'<col width="'+(o/i*100).toFixed(2)+'%">'},"")+"</colgroup>";t.prepend(H)}},calcCellMergeRange:function(t,e){var a=this,b=a.tableBodyElements;"TH"===t.tagName&&(b=a.tableHeadElements);var n={firstPoint:t.firstPoint,lastPoint:t.lastPoint},o={firstPoint:e.firstPoint,lastPoint:e.lastPoint},l=Math.min(n.firstPoint.row,n.lastPoint.row,o.firstPoint.row,o.lastPoint.row),r=Math.min(n.firstPoint.col,n.lastPoint.col,o.firstPoint.col,o.lastPoint.col),i=Math.max(n.firstPoint.row,n.lastPoint.row,o.firstPoint.row,o.lastPoint.row),s=Math.max(n.firstPoint.col,n.lastPoint.col,o.firstPoint.col,o.lastPoint.col);a.finalRange=function t(e,a,n,o){for(var l=e,r=a,i=n,s=o,d=e;d<=n;d++)for(var c=a;c<=o;c++){var h=b[d][c],p=h.firstPoint,m=h.lastPoint;l=Math.min(parseInt(p.row),parseInt(m.row),l),r=Math.min(p.col,m.col,r),i=Math.max(p.row,m.row,i),s=Math.max(p.col,m.col,s)}return l==e&&r==a&&i==n&&s==o?{minRow:e,minCol:a,maxRow:n,maxCol:o}:t(l,r,i,s)}(l,r,i,s),a.selectedRowRange=i-l+1,a.selectedColRange=s-r+1},renderCellMergeRange:function(t,e){var a=e.minRow,n=e.minCol,o=e.maxRow,l=e.maxCol,r=this.tableBodyElements;"TH"===t&&(r=this.tableHeadElements);for(var i=a;i<=o;i++)for(var s=n;s<=l;s++){var d=r[i][s];$(d).attr("data-active","")}},savePosition:function(t,e){t.lastPoint||(t.firstPoint=e),t.lastPoint=e},calcTableElementPosition:function(t){var h=this;this.tableBodyElements=[],this.tableHeadElements=[];var e=t.find("thead"),a=t.find("tbody");function d(t,e,a,n,o){var l=t.tagName,r=h.tableBodyElements;"TH"===l&&(r=h.tableHeadElements);for(var i=parseInt(e)+parseInt(n),s=parseInt(o)+parseInt(a),d=e;d<i;d++)for(var c=a;c<s;c++)r[d]=r[d]||[],r[d][c]=t}[e,a].map(function(t){var s=h.tableBodyElements;t===e&&(s=h.tableHeadElements),t.find("tr").each(function(r){var t=$(this);s[r]=s[r]||[];var i=0;t.find("td,th").each(function(){var t=$(this).attr("rowspan")||1,e=$(this).attr("colspan")||1;if(s[r][i]){var a=s[r][i],n=$(a).attr("rowspan")||1,o=$(a).attr("colspan")||1;if(1<n||1<o){var l=function t(e,a){var n=s[e][a],o=$(n).attr("rowspan")||1,l=$(n).attr("colspan")||1;return 1<o||1<l?t(e,a+=Number(l)):{indexTr:e,tdIndex:a}}(r,i);i=Number(l.tdIndex),1<t||1<e?(d(this,r,i,t,e),i+=Number(e)):(s[r][i]=this,i++)}else i++}else 1<t||1<e?(d(this,r,i,t,e),i+=Number(e)):(s[r][i]=this,i++)})})}),[h.tableBodyElements,h.tableHeadElements].map(function(t){t.forEach(function(t,e){t.forEach(function(t,e){t.lastPoint=void 0})}),t.forEach(function(t,a){t.forEach(function(t,e){h.savePosition(t,{row:a,col:e})})})})},insert:function(){var t=this.component.create("table");t.$element.addClass("table-asics-richeditor");for(var e=0;e<2;e++)t.addRow(3);t=this.insertion.insertHtml(t),this.caret.setStart(t)},addRowAbove:function(){var t=this._getTable();if(t){var e=this.selection.getCurrent(),a=$(e).closest("td,th")[0],n="td",o=this.tableBodyElements;"TH"===a.tagName&&(o=this.tableHeadElements,n="th");for(var l=a.firstPoint.row,r=o[0].length,i=$("<tr></tr>"),s=0;s<r;s++){var d=o[l][s],c=parseInt($(d).attr("colspan")||1),h=parseInt($(d).attr("rowspan")||1);d.firstPoint.row==l?i.append("<"+n+' contenteditable="true"></'+n+">"):(1<c||1<h)&&($(d).attr("data-spanupdated")||1<h&&($(d).attr("rowspan",h+1),$(d).attr("data-spanupdated","true")))}i.insertBefore($(e).closest("tr")),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),this.calcTableElementPosition($(t)),this.renderColGroup($(t))}},addRowBelow:function(){var t=this._getTable();if(t){var e=this.selection.getCurrent(),a=$(e).closest("td,th")[0],n=this.tableBodyElements,o="td";"TH"===a.tagName&&(n=this.tableHeadElements,o="th");for(var l=a.lastPoint.row,r=n[0].length,i=$("<tr></tr>"),s=0;s<r;s++){var d=n[l][s],c=parseInt($(d).attr("colspan")||1),h=parseInt($(d).attr("rowspan")||1);d.lastPoint.row==l?i.append("<"+o+' contenteditable="true"></'+o+">"):(1<c||1<h)&&($(d).attr("data-spanupdated")||1<h&&($(d).attr("rowspan",h+1),$(d).attr("data-spanupdated","true")))}var p=n[a.lastPoint.row].filter(function(t){return 1==t.colSpan&&1==t.rowSpan});0<p.length&&(i.insertAfter($(p[0]).closest("tr")),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),this.calcTableElementPosition($(t)),this.renderColGroup($(t)))}},addColumnLeft:function(){var i=this,t=this._getTable();if(t){var e=this.selection.getCurrent(),s=$(e).closest("td,th")[0].firstPoint.col;[i.tableBodyElements,i.tableHeadElements].map(function(t){var e=t.length,a="td";t===i.tableHeadElements&&(a="th");for(var n=0;n<e;n++){var o=t[n][s],l=parseInt($(o).attr("colspan")||1),r=parseInt($(o).attr("rowspan")||1);0==s?$(o).closest("thead,tbody").find("tr").eq(n).prepend("<"+a+' contenteditable="true"></'+a+">"):o.firstPoint.row==n&&(1<l||1<r?$(o).attr("data-spanupdated")||($(o).attr("colspan",l+1),$(o).attr("data-spanupdated","true")):$("<"+a+' contenteditable="true"></'+a+">").insertBefore(o))}}),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),i.calcTableElementPosition($(t)),i.renderColGroup($(t))}},addColumnRight:function(){var s=this,t=this._getTable();if(t){var e=this.selection.getCurrent(),d=$(e).closest("td,th")[0].lastPoint.col;[s.tableBodyElements,s.tableHeadElements].map(function(t){var e=t.length,a="td";t===s.tableHeadElements&&(a="th");for(var n=t[0].length,o=0;o<e;o++){var l=t[o][d],r=parseInt($(l).attr("colspan")||1),i=parseInt($(l).attr("rowspan")||1);d==n-1?$(l).closest("thead,tbody").find("tr").eq(o).append("<"+a+' contenteditable="true"></'+a+">"):l.lastPoint.row==o&&(1<r||1<i?$(l).attr("data-spanupdated")||($(l).attr("colspan",r+1),$(l).attr("data-spanupdated","true")):$("<"+a+' contenteditable="true"></'+a+">").insertAfter(l))}}),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),s.calcTableElementPosition($(t)),s.renderColGroup($(t))}},addHead:function(){var t=this._getComponent();t&&(this.selection.save(),t.addHead(),this.selection.restore())},deleteHead:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent();0!==r.dom(e).closest("thead").length?(t.removeHead(),this.caret.setStart(t)):(this.selection.save(),t.removeHead(),this.selection.restore())}},deleteColumn:function(){var t=this._getTable();if(t){var e=this.selection.getCurrent(),r=$(e).closest("td,th")[0].firstPoint.col;[this.tableBodyElements,this.tableHeadElements].map(function(t){for(var e=t.length,a=0;a<e;a++){var n=t[a][r],o=parseInt($(n).attr("colspan")||1),l=parseInt($(n).attr("rowspan")||1);n.firstPoint.row==a&&(1<o||1<l?$(n).attr("data-spanupdated")||(1<o?($(n).attr("colspan",o-1),$(n).attr("data-spanupdated","true")):$(n).remove()):$(n).remove())}}),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),this.calcTableElementPosition($(t)),this.renderColGroup($(t))}},deleteRow:function(){var t=this._getTable();if(t){var e=this.selection.getCurrent(),a=$(e).closest("td,th"),n=a[0],o=this.tableBodyElements;"TH"===n.tagName&&(o=this.tableHeadElements);for(var l=a.closest("tr"),r=n.firstPoint.row,i=o[0].length,s=0;s<i;s++){var d=o[r][s],c=parseInt($(d).attr("colspan")||1),h=parseInt($(d).attr("rowspan")||1);d.firstPoint.col==s&&(1<c||1<h?$(d).attr("data-spanupdated")?$(d).remove():1<h&&($(d).attr("rowspan",h-1),$(d).attr("data-spanupdated","true"),d.firstPoint.row==r&&(s-1<0?l.next().prepend(d):$(d).insertAfter(o[r+1][s-1]))):$(d).remove())}l.remove(),$(t).find("[data-spanupdated]").removeAttr("data-spanupdated"),this.calcTableElementPosition($(t)),this.renderColGroup($(t))}},mergeCell:function(){var t=this,e=this._getTable();if(e&&this._getComponent()){var a=this.selection.getCurrent(),n=$(a).closest("tbody,thead"),o=t.tableBodyElements;"THEAD"===n[0].tagName&&(o=t.tableHeadElements);var l=t.finalRange,r=l.minRow,i=l.minCol,s=l.maxRow,d=l.maxCol,c=$(o[r][i]),h=c.attr("rowspan")||1,p=c.attr("colspan")||1;h=Math.max(h-1,t.selectedRowRange),c.attr("rowspan",h),p=Math.max(p-1,t.selectedColRange),c.attr("colspan",p);for(var m=r;m<=s;m++)for(var b=i;b<=d;b++){var u=o[m][b];u!=c[0]&&$(u).remove(),o[m][b]=c[0],t.savePosition(o[m][b],{x:m,y:b})}t.renderColGroup($(e))}},deleteTable:function(){var t=this._getTable();t&&this.component.remove(t)},clearTableTheme:function(){var t=this._getTable();t&&r.dom(t).removeClass(this.opts.tableClassNames.toString().replace(/[,;]/g," "))},setTableTheme:function(t){var e=this._getTable();e&&(this.clearTableTheme(),r.dom(e).addClass(t.classValue),this.app.api("module.modal.close"))},setTableThemeModal:function(){this.app.api("module.modal.build",{name:"setTableThemeModal",title:"Set table theme",handle:"save",commands:{save:{title:"Save"},cancel:{title:"Cancel"}}})},_getTable:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t);if(e.isTable())return e.getTable()},_getComponent:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t);if(e.isTable()){var a=e.getTable();return this.component.create("table",a)}},_observeDropdown:function(t){var e=this._getTable(),a=t.getItemsByClass("redactor-table-item-observable"),n=t.getItem("insert-table");e?(this._observeItems(a,"enable"),n.disable()):(this._observeItems(a,"disable"),n.enable())},_observeItems:function(t,e){for(var a=0;a<t.length;a++)t[a][e]()}}),r.add("class","table.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},addHead:function(){this.removeHead();var t=this.$element.find("tr").first().children("td, th"),e=0;t.each(function(t){e+=t.colSpan});var a=r.dom("<thead>"),n=this._buildRow(e,"<th>");a.append(n),this.$element.prepend(a)},addRow:function(t){var e=this._buildRow(t);return this.$element.append(e),e},addRowTo:function(t,e){return this._addRowTo(t,e)},addColumnTo:function(t,o){var e=r.dom(t),a=e.closest("tr"),n=e.closest("td, th"),l=0;a.find("td, th").each(function(t,e){t===n.get()&&(l=e)}),this.$element.find("tr").each(function(t){var e=r.dom(t).find("td, th").get(l),a=r.dom(e),n=a.clone();n.html(""),"right"===o?a.after(n):a.before(n)})},removeHead:function(){var t=this.$element.find("thead");0!==t.length&&t.remove()},removeRow:function(t){r.dom(t).closest("tr").remove()},removeColumn:function(t){var e=r.dom(t),a=e.closest("tr"),n=e.closest("td, th"),o=0;a.find("td, th").each(function(t,e){t===n.get()&&(o=e)}),this.$element.find("tr").each(function(t){var e=r.dom(t).find("td, th").get(o);r.dom(e).remove()})},_init:function(t){var e,a;if(void 0!==t){var n=r.dom(t),o=n.get(),l=n.closest("figure");0!==l.length?a=(e=l).find("table").get():"TABLE"===o.tagName&&(a=o)}this._buildWrapper(e),this._buildElement(a),this._initWrapper()},_addRowTo:function(t,e){var a=r.dom(t).closest("tr");if(0!==a.length){var n=a.children("td, th").length,o=this._buildRow(n);return a[e](o),o}},_buildRow:function(t,e){e=e||"<td>";for(var a=r.dom("<tr>"),n=0;n<t;n++){var o=r.dom(e);o.attr("contenteditable",!0),a.append(o)}return a},_buildElement:function(t){t?this.$element=r.dom(t):(this.$element=r.dom("<table>"),this.append(this.$element))},_buildWrapper:function(t){t=t||"<figure>",this.parse(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1})}})}(window.Redactor);